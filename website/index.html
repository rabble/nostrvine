<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpenVine</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Pacifico&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="main.css?v=1">
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <meta name="description" content="Watch and share 6-second looping videos">
</head>
<body>
    <!-- Header -->
    <header class="vine-header">
        <div class="vine-header-bg"></div>
        <div class="vine-header-content">
            <a href="/" class="vine-logo">OpenVine</a>
            <div class="vine-auth-buttons">
                <a href="https://app.openvine.co" class="vine-auth-btn vine-login-btn">Log in</a>
            </div>
        </div>
        <div class="vine-hero-section">
            <h1 class="vine-tagline">Return to a world of beautiful, looping videos.</h1>
            <div class="vine-search-container">
                <input type="text" class="vine-search-input" placeholder="Search" id="vineSearchInput" onkeypress="if(event.key==='Enter')searchVines()">
            </div>
            <div class="vine-app-buttons">
                <a href="open-source.html" class="vine-app-btn vine-ios-btn">
                    <span class="vine-app-icon">🍎</span>
                    <span>Get it on<br><strong>iOS</strong></span>
                </a>
                <a href="open-source.html" class="vine-app-btn vine-android-btn">
                    <span class="vine-app-icon">🤖</span>
                    <span>Get it on<br><strong>Android</strong></span>
                </a>
                <a href="open-source.html" class="vine-app-btn vine-windows-btn">
                    <span class="vine-app-icon">🪟</span>
                    <span>Get it on<br><strong>Windows</strong></span>
                </a>
                <a href="open-source.html" class="vine-app-btn vine-mac-btn">
                    <span class="vine-app-icon">💻</span>
                    <span>Get it on<br><strong>macOS</strong></span>
                </a>
                <a href="open-source.html" class="vine-app-btn vine-linux-btn">
                    <span class="vine-app-icon">🐧</span>
                    <span>Get it on<br><strong>Linux</strong></span>
                </a>
            </div>
        </div>
    </header>

    <!-- Main Container -->
    <div class="vine-main-container">
        <!-- Left Sidebar - Categories -->
        <aside class="vine-sidebar-left">
            <div class="vine-categories">
                <h3>Channels</h3>
                <div class="vine-category-grid">
                    <!-- Row 1 -->
                    <div class="vine-category-item" onclick="showPlaylist('editors-picks')" title="Editor's Picks">📹</div>
                    <div class="vine-category-item" onclick="showPlaylist('featured')" title="Featured Viners">⭐</div>
                    <div class="vine-category-item" onclick="filterByCategory('comedy')" title="Comedy">😂</div>
                    <div class="vine-category-item" onclick="filterByCategory('cool')" title="Cool">😎</div>
                    
                    <!-- Row 2 -->
                    <div class="vine-category-item" onclick="filterByCategory('girls')" title="Girls">👧</div>
                    <div class="vine-category-item" onclick="filterByCategory('guys')" title="Guys">🧔</div>
                    <div class="vine-category-item" onclick="filterByCategory('gaming')" title="Gaming">🎮</div>
                    <div class="vine-category-item" onclick="filterByCategory('popnow')" title="Pop Now">💥</div>
                    
                    <!-- Row 3 -->
                    <div class="vine-category-item" onclick="filterByCategory('musicdance')" title="Music & Dance">🎵</div>
                    <div class="vine-category-item" onclick="filterByCategory('ideas')" title="Ideas">💡</div>
                    <div class="vine-category-item" onclick="filterByCategory('trending')" title="Trending">📊</div>
                    <div class="vine-category-item" onclick="filterByCategory('special')" title="Special">⚡</div>
                    
                    <!-- Row 4 -->
                    <div class="vine-category-item" onclick="filterByCategory('animals')" title="Animals">🦊</div>
                    <div class="vine-category-item" onclick="filterByCategory('places')" title="Places & Travel">🗺️</div>
                    <div class="vine-category-item" onclick="filterByCategory('family')" title="Family">👨‍👩‍👧‍👦</div>
                    <div class="vine-category-item" onclick="filterByCategory('artdesign')" title="Art & Design">🎨</div>
                    
                    <!-- Row 5 -->
                    <div class="vine-category-item" onclick="filterByCategory('scary')" title="Scary">💀</div>
                    <div class="vine-category-item" onclick="filterByCategory('sports')" title="Sports">🏃</div>
                    <div class="vine-category-item" onclick="filterByCategory('cars')" title="Cars">🚗</div>
                    <div class="vine-category-item" onclick="filterByCategory('food')" title="Food">🍔</div>
                    
                    <!-- Row 6 -->
                    <div class="vine-category-item" onclick="filterByCategory('diy')" title="DIY">🔨</div>
                    <div class="vine-category-item" onclick="filterByCategory('news')" title="News & Politics">📱</div>
                    <div class="vine-category-item" onclick="filterByCategory('fashion')" title="Fashion & Beauty">💄</div>
                    <div class="vine-category-item" onclick="filterByCategory('nature')" title="Nature">🏔️</div>
                </div>
            </div>
            
            <!-- Editor's Pick -->
            <!-- <div class="vine-editors-pick">
                <h3>Editor's Pick</h3>
                <div class="vine-editors-video" id="editorsPickVideo">
                </div>
            </div> -->
            
            <!-- About OpenVine -->
            <div class="vine-about-section">
                <h3>Welcome back</h3>
                <p>OpenVine brings back 6-second looping videos. No algorithms. No filters. Just pure, authentic creativity.</p>
                <a href="about.html" class="vine-about-link">Our story →</a>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="vine-main-content">
            <!-- Video Feed Container -->
            <div class="vine-video-feed" id="vineVideoFeed">
                <!-- Videos will be dynamically loaded here -->
            </div>
        </main>
    </div>

    <script>
        // Load videos from manifest
        let HOMEPAGE_VIDEOS = [];
        
        // Load manifest data
        async function loadManifestVideos() {
            try {
                const response = await fetch('openvine_homepage_manifest.json');
                const manifest = await response.json();
                
                // Convert manifest videos to our format
                HOMEPAGE_VIDEOS = manifest.homepage_selection.map(video => ({
                    id: video.vine_id,
                    url: video.video_url,
                    thumbnail: video.thumbnail_url,
                    username: video.author,
                    title: video.title,
                    avatar: getCategoryEmoji(video.category_name),
                    likes: Math.floor(video.loop_count * 0.1),
                    comments: Math.floor(video.loop_count * 0.05),
                    reposts: Math.floor(video.loop_count * 0.02),
                    loops: video.loop_count,
                    category: getCategorySlug(video.category_name)
                }));
                
                console.log(`Loaded ${HOMEPAGE_VIDEOS.length} videos from manifest`);
                
                // Initialize with shuffled videos
                currentVideos = shuffleArray([...HOMEPAGE_VIDEOS]);
                featuredVideoIndex = 0;
                
                // Load the UI
                loadVideoFeed();
                loadFromVineIntegration();
                
            } catch (error) {
                console.error('Error loading manifest:', error);
                // Fallback to hardcoded videos
                loadFallbackVideos();
            }
        }
        
        // Get category emoji based on name
        function getCategoryEmoji(categoryName) {
            const categoryEmojis = {
                "Editor's Picks": '📹',
                'Trending': '📊',
                'Comedy': '😂',
                'Gaming': '🎮',
                'Animals': '🦊',
                'Sports': '🏃',
                'Music & Dance': '🎵',
                'Cool': '😎',
                'Ideas': '💡',
                'Special': '⚡'
            };
            return categoryEmojis[categoryName] || '🎬';
        }
        
        // Get category slug
        function getCategorySlug(categoryName) {
            const slugMap = {
                "Editor's Picks": 'editors-picks',
                'Trending': 'trending',
                'Comedy': 'comedy',
                'Gaming': 'gaming',
                'Animals': 'animals',
                'Sports': 'sports',
                'Music & Dance': 'musicdance',
                'Cool': 'cool',
                'Ideas': 'ideas',
                'Special': 'special'
            };
            return slugMap[categoryName] || categoryName.toLowerCase();
        }
        
        // Fallback videos if manifest fails
        function loadFallbackVideos() {
            HOMEPAGE_VIDEOS = [
            {
                id: 'OuTVHxUPzmt',
                url: 'https://api.openvine.co/media/1751108556977-3468cf13',
                thumbnail: 'https://api.openvine.co/media/1751108559860-6fbceed1',
                username: 'Tortilla',
                title: 'Vine',
                avatar: '📹',
                likes: Math.floor(Math.random() * 5000),
                comments: Math.floor(Math.random() * 200),
                reposts: Math.floor(Math.random() * 100),
                loops: 0,
                category: 'editors-picks'
            },
            {
                id: '5003PhXAQFz',
                url: 'https://api.openvine.co/media/1751108620337-cd2ac64a',
                thumbnail: 'https://api.openvine.co/media/1751108623191-9a83f4a4',
                username: 'Unknown',
                title: '#roblox #death sound #wii. Full version on my #musically (tall). 1/2 size on #Instagram. Kennethudut #random #dank',
                avatar: '🎮',
                likes: Math.floor(1393 * 0.1),
                comments: Math.floor(1393 * 0.05),
                reposts: Math.floor(1393 * 0.02),
                loops: 1393,
                category: 'gaming'
            },
            {
                id: 'eKgPlwwuwYp',
                url: 'https://api.openvine.co/media/1751108627713-39ed780b',
                thumbnail: 'https://api.openvine.co/media/1751108630860-7cc1b4ff',
                username: 'Kj The Bosss',
                title: 'Watch KingBach\'s Vine "When bae laughs too hard at a text message. 😡😂 W/ Curtis, SillyGirlCarmen #KingBach"',
                avatar: '😂',
                likes: Math.floor(Math.random() * 10000),
                comments: Math.floor(Math.random() * 500),
                reposts: Math.floor(Math.random() * 200),
                loops: 0,
                category: 'comedy'
            },
            {
                id: 'edrTBg2YuZE',
                url: 'https://api.openvine.co/media/1751108635971-d113334a',
                thumbnail: 'https://api.openvine.co/media/1751108638746-ee849e61',
                username: 'Marcos Jimenez',
                title: 'Watch Zach King\'s Vine "When you win at solitaire ♣️♦️"',
                avatar: '♠️',
                likes: Math.floor(Math.random() * 8000),
                comments: Math.floor(Math.random() * 400),
                reposts: Math.floor(Math.random() * 150),
                loops: 0,
                category: 'comedy'
            },
            {
                id: 'MaBKAD13T2m',
                url: 'https://api.openvine.co/media/1751108643309-7d1cc767',
                thumbnail: 'https://api.openvine.co/media/1751108646123-781d5464',
                username: 'Unknown',
                title: 'oh so tracy\'s post on Vine',
                avatar: '📱',
                likes: Math.floor(Math.random() * 3000),
                comments: Math.floor(Math.random() * 150),
                reposts: Math.floor(Math.random() * 75),
                loops: 0,
                category: 'editors-picks'
            },
            {
                id: 'Omb0atqb1Ur',
                url: 'https://api.openvine.co/media/1751108650751-60c7403f',
                thumbnail: 'https://api.openvine.co/media/1751108653453-2253a205',
                username: 'Blake Griffie',
                title: 'Hit that raven for the Vine @reinek_',
                avatar: '🦅',
                likes: Math.floor(Math.random() * 5000),
                comments: Math.floor(Math.random() * 250),
                reposts: Math.floor(Math.random() * 100),
                loops: 0,
                category: 'animals'
            },
            {
                id: 'MKAExjBYQ0Z',
                url: 'https://api.openvine.co/media/1751108665248-352c2d1e',
                thumbnail: 'https://api.openvine.co/media/1751108669004-0bb5f787',
                username: 'Daniel Hernandez',
                title: 'Trick shot #trickshot #basketball',
                avatar: '🏀',
                likes: Math.floor(Math.random() * 7000),
                comments: Math.floor(Math.random() * 350),
                reposts: Math.floor(Math.random() * 140),
                loops: 0,
                category: 'sports'
            },
            {
                id: 'h5mjKW2inO6',
                url: 'https://api.openvine.co/media/1751108674982-2020db64',
                thumbnail: 'https://api.openvine.co/media/1751108678734-dc301046',
                username: 'deenaa',
                title: 'PANORAMIC W/TRINH NGUYEN',
                avatar: '📷',
                likes: Math.floor(Math.random() * 4000),
                comments: Math.floor(Math.random() * 200),
                reposts: Math.floor(Math.random() * 80),
                loops: 0,
                category: 'special'
            },
            {
                id: '5003BO6PlOQ',
                url: 'https://api.openvine.co/media/1751108684031-b3892dcb',
                thumbnail: 'https://api.openvine.co/media/1751108686848-8c7c79b5',
                username: 'Unknown',
                title: '@knightqueenology secret santa \n\nSorry if you haven\'t seen it, its from the anime cowboy bebop',
                avatar: '🎁',
                likes: Math.floor(215 * 0.1),
                comments: Math.floor(215 * 0.05),
                reposts: Math.floor(215 * 0.02),
                loops: 215,
                category: 'special'
            },
            {
                id: 'MTx9LF1PdbB',
                url: 'https://api.openvine.co/media/1751108700557-e979fb59',
                thumbnail: 'https://api.openvine.co/media/1751108703347-2950964a',
                username: 'Jay',
                title: 'LIC 💥💥 #ilovesickdrops #EastCoastRavers #CARNAGE',
                avatar: '💥',
                likes: Math.floor(Math.random() * 3000),
                comments: Math.floor(Math.random() * 150),
                reposts: Math.floor(Math.random() * 60),
                loops: 0,
                category: 'special'
            },
            {
                id: 'hPT1TVKe9Yj',
                url: 'https://api.openvine.co/media/1751108707974-dabd1462',
                thumbnail: 'https://api.openvine.co/media/1751108709686-3b069a28',
                username: 'Faith Hope Bascon',
                title: '@ilovesickdrops #ilovesickdrops #EDM',
                avatar: '🎧',
                likes: Math.floor(Math.random() * 2500),
                comments: Math.floor(Math.random() * 125),
                reposts: Math.floor(Math.random() * 50),
                loops: 0,
                category: 'editors-picks'
            },
            {
                id: 'e72TapV0DwP',
                url: 'https://api.openvine.co/media/1751108713179-5eba4047',
                thumbnail: 'https://api.openvine.co/media/1751108714945-c32e848f',
                username: 'MattAttack015',
                title: 'Watch YouTube.com/ThomasSanders\'s Vine "Fear Me 💪 (W/ LEO THE GIANT, Phil Young, & Dom Gold)"',
                avatar: '💪',
                likes: Math.floor(Math.random() * 4000),
                comments: Math.floor(Math.random() * 200),
                reposts: Math.floor(Math.random() * 80),
                loops: 0,
                category: 'special'
            },
            {
                id: 'ejJ77gjHQMT',
                url: 'https://api.openvine.co/media/1751108718474-16f3b3da',
                thumbnail: 'https://api.openvine.co/media/1751108720191-aa482de2',
                username: 'Erin Marie',
                title: 'Watch Zach King\'s Vine "Back to school like..."',
                avatar: '🎒',
                likes: Math.floor(Math.random() * 6000),
                comments: Math.floor(Math.random() * 300),
                reposts: Math.floor(Math.random() * 120),
                loops: 0,
                category: 'comedy'
            },
            {
                id: 'ej0IWjZVAUQ',
                url: 'https://api.openvine.co/media/1751108723706-51ecbdbc',
                thumbnail: 'https://api.openvine.co/media/1751108725774-aedb7101',
                username: 'Beach Crew',
                title: 'Watch Nash Grier\'s Vine "Chameleons are the 💩"',
                avatar: '🦎',
                likes: Math.floor(Math.random() * 5000),
                comments: Math.floor(Math.random() * 250),
                reposts: Math.floor(Math.random() * 100),
                loops: 0,
                category: 'animals'
            },
            {
                id: 'eIl5BvgIXMY',
                url: 'https://api.openvine.co/media/1751108729322-ca10b44b',
                thumbnail: 'https://api.openvine.co/media/1751108731003-cefd8a42',
                username: 'Zane Maddox',
                title: 'Watch Jake Paul\'s Vine "When you can\'t get into a party... (w/ Curtis Lepore, Mark Dohner, JoJoe, Alissa Violet )"',
                avatar: '🎉',
                likes: Math.floor(Math.random() * 8000),
                comments: Math.floor(Math.random() * 400),
                reposts: Math.floor(Math.random() * 160),
                loops: 0,
                category: 'comedy'
            },
            {
                id: 'ep5H6QlgLKV',
                url: 'https://api.openvine.co/media/1751108734460-d82f2ba8',
                thumbnail: 'https://api.openvine.co/media/1751108736038-02994255',
                username: 'brenda',
                title: 'Watch Zach King\'s Vine "Rolling out of bed in the morning..."',
                avatar: '😎',
                likes: Math.floor(Math.random() * 6000),
                comments: Math.floor(Math.random() * 300),
                reposts: Math.floor(Math.random() * 120),
                loops: 0,
                category: 'cool'
            },
            {
                id: 'MrlXQ1ViZnW',
                url: 'https://api.openvine.co/media/1751108739525-7c6fa7e3',
                thumbnail: 'https://api.openvine.co/media/1751108741129-7129e54f',
                username: 'Andrew Childers',
                title: 'Happy $tar Wars Day! #maythe4thbewithyou',
                avatar: '⚡',
                likes: Math.floor(Math.random() * 4000),
                comments: Math.floor(Math.random() * 200),
                reposts: Math.floor(Math.random() * 80),
                loops: 0,
                category: 'ideas'
            },
            {
                id: '5002wXwQOKX',
                url: 'https://api.openvine.co/media/1751108751373-97ae67a3',
                thumbnail: 'https://api.openvine.co/media/1751108754194-19544847',
                username: 'Unknown',
                title: 'Wauligi you look horrible #FollowMe  #musically  marioandbuddies2 my account name',
                avatar: '🎮',
                likes: Math.floor(44 * 0.1),
                comments: Math.floor(44 * 0.05),
                reposts: Math.floor(44 * 0.02),
                loops: 44,
                category: 'gaming'
            },
            {
                id: 'MUq1itKiPhQ',
                url: 'https://api.openvine.co/media/1751108757793-df6b608b',
                thumbnail: 'https://api.openvine.co/media/1751108759223-6419c718',
                username: 'Keyona Green',
                title: 'The Legend of Zelda - Lost Woods/Saria\'s Song {Inspired by Trench}',
                avatar: '🎮',
                likes: Math.floor(Math.random() * 3000),
                comments: Math.floor(Math.random() * 150),
                reposts: Math.floor(Math.random() * 60),
                loops: 0,
                category: 'gaming'
            }
        ];
            
            // Apply shuffle
            currentVideos = shuffleArray([...HOMEPAGE_VIDEOS]);
            featuredVideoIndex = 0;
        }

        const FEATURED_USERS = [
            { username: 'KingBach', avatar: '👑', followers: '16.2M' },
            { username: 'Zach King', avatar: '🎩', followers: '14.7M' },
            { username: 'Lele Pons', avatar: '💃', followers: '11.5M' },
            { username: 'Logan Paul', avatar: '🥊', followers: '9.4M' },
            { username: 'Brittany Furlan', avatar: '🌟', followers: '9.8M' }
        ];

        // Shuffle array function
        function shuffleArray(array) {
            const shuffled = [...array];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        }

        // State
        let currentVideos = []; // Will be loaded from manifest
        let featuredVideoIndex = 0;

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            // Load videos from manifest first
            loadManifestVideos();
        });

        // Setup audio controls
        function setupAudioControls() {
            const unmuteOverlay = document.getElementById('vineUnmuteOverlay');
            const player = document.getElementById('vineFeaturedPlayer');
            
            if (unmuteOverlay && player) {
                unmuteOverlay.addEventListener('click', () => {
                    isMuted = false;
                    player.muted = false;
                    unmuteOverlay.style.display = 'none';
                    player.play();
                });

                // Hide controls after interaction
                player.controls = false;
                
                // Show unmute overlay initially
                if (isMuted) {
                    unmuteOverlay.style.display = 'flex';
                }
            }
        }

        // Global mute state
        let isMuted = true;

        // Calculate time ago from timestamp
        function getTimeAgo(timestamp) {
            // These are archived vines from 2013-2017 era
            // Let's show realistic years ago
            const yearsAgo = Math.floor(Math.random() * 4) + 8; // 8-11 years ago (2013-2016)
            return `${yearsAgo} years ago`;
        }

        // Load video feed
        function loadVideoFeed() {
            const feed = document.getElementById('vineVideoFeed');
            if (!feed) return;
            
            // Clear existing content
            feed.innerHTML = '';
            
            // Create video feed items
            currentVideos.forEach((video, index) => {
                const videoItem = document.createElement('div');
                videoItem.className = 'vine-video-feed-item';
                videoItem.innerHTML = `
                    <div class="vine-video-header">
                        <div class="vine-user-avatar">${video.avatar}</div>
                        <div class="vine-user-info">
                            <div class="vine-username">${video.username}</div>
                            <div class="vine-timestamp">${getTimeAgo()}</div>
                        </div>
                    </div>
                    <div class="vine-video-container">
                        <video src="${video.url}" 
                               id="video-${video.id}"
                               loop 
                               ${isMuted ? 'muted' : ''}
                               playsinline
                               onclick="toggleVideoPlay('${video.id}')"
                               onmouseover="this.play()" 
                               onmouseout="this.pause()">
                        </video>
                    </div>
                    <div class="vine-video-footer">
                        <div class="vine-video-caption">${video.title}</div>
                        <div class="vine-video-stats">
                            <span>❤️ ${video.likes.toLocaleString()}</span>
                            <span>💬 ${video.comments.toLocaleString()}</span>
                            <span>🔄 ${video.reposts.toLocaleString()}</span>
                            <span>👁️ ${video.loops.toLocaleString()} loops</span>
                        </div>
                    </div>
                `;
                feed.appendChild(videoItem);
            });
        }
        
        // Toggle video play/pause and global mute
        function toggleVideoPlay(videoId) {
            const clickedVideo = document.getElementById(`video-${videoId}`);
            if (!clickedVideo) return;
            
            if (clickedVideo.paused) {
                // If unmuting for the first time, unmute all videos globally
                if (isMuted) {
                    isMuted = false;
                    // Unmute all videos
                    document.querySelectorAll('video').forEach(video => {
                        video.muted = false;
                    });
                }
                clickedVideo.play();
            } else {
                clickedVideo.pause();
            }
        }

        // Load playlist video
        function loadPlaylistVideo() {
            if (currentVideos.length === 0) return;
            
            const video = currentVideos[featuredVideoIndex];
            const player = document.getElementById('vinePlaylistPlayer');
            const title = document.getElementById('playlistVideoTitle');
            const currentIndex = document.getElementById('currentVideoIndex');
            const totalVideos = document.getElementById('totalVideos');
            const loopCount = document.getElementById('loopCount');

            if (player && video.url) {
                // Remove old source
                player.pause();
                player.src = video.url;
                console.log('Loading video:', video.url, 'for video:', video.title);
                // Check if VineState is available from vine-integration.js
                if (typeof window.VineState !== 'undefined') {
                    player.muted = window.VineState.playlistMuted;
                    player.volume = window.VineState.playlistMuted ? 0 : 1.0;
                } else {
                    player.muted = isMuted;
                    player.volume = isMuted ? 0 : 1.0;
                }
                
                // Add error handling for broken videos
                player.addEventListener('error', function handleVideoError() {
                    console.log('Video failed to load:', video.url);
                    // Skip to next video if this one fails
                    setTimeout(() => {
                        featuredVideoIndex = (featuredVideoIndex + 1) % currentVideos.length;
                        loadPlaylistVideo();
                    }, 1000);
                    player.removeEventListener('error', handleVideoError);
                });
                
                player.load();
                
                // Check if video has audio track
                player.addEventListener('loadedmetadata', function checkAudio() {
                    console.log('Video loaded - Duration:', player.duration, 'Has Audio:', player.mozHasAudio || player.webkitAudioDecodedByteCount > 0 || player.audioTracks?.length > 0);
                    player.removeEventListener('loadedmetadata', checkAudio);
                });
                
                player.play().catch(e => {
                    console.log('Autoplay prevented:', e);
                    player.muted = true;
                    isMuted = true;
                    player.play().catch(e2 => {
                        console.log('Even muted autoplay failed:', e2);
                        // If video won't play at all, skip to next
                        setTimeout(() => {
                            featuredVideoIndex = (featuredVideoIndex + 1) % currentVideos.length;
                            loadPlaylistVideo();
                        }, 2000);
                    });
                });
            }
            
            if (title) title.textContent = video.username;
            if (currentIndex) currentIndex.textContent = featuredVideoIndex + 1;
            if (totalVideos) totalVideos.textContent = currentVideos.length;
            if (loopCount) loopCount.textContent = video.loops === 0 ? 'unknown' : video.loops.toLocaleString();
        }

        // Load video grid
        function loadVideoGrid() {
            const grid = document.getElementById('vineVideoGrid');
            if (!grid) return;
            
            grid.innerHTML = currentVideos.map((video, index) => `
                <div class="vine-grid-item" data-video-id="${video.id}" onclick="playVideo('${video.id}')">
                    <div class="vine-grid-thumbnail" id="thumb-${video.id}">
                        <canvas width="400" height="400" style="width: 100%; height: 100%; position: absolute; top: 0; left: 0;"></canvas>
                        <div class="vine-grid-overlay">
                            <div class="vine-grid-avatar">${video.avatar}</div>
                            <span class="vine-grid-user">${video.username}</span>
                        </div>
                    </div>
                    <div class="vine-grid-info">
                        <div class="vine-grid-avatar" style="width: 20px; height: 20px; font-size: 10px;">${video.avatar}</div>
                        <span style="font-size: 11px; color: #333;">${video.username}</span>
                        <div class="vine-grid-stats">
                            <span>❤️ ${video.likes}</span>
                            <span>💬 ${video.comments}</span>
                            <span>🔄 ${video.reposts}</span>
                        </div>
                    </div>
                </div>
            `).join('');
            
            // Add placeholder for empty slots to maintain grid
            const remainingSlots = 9 - (currentVideos.length % 9);
            if (remainingSlots < 9) {
                for (let i = 0; i < remainingSlots; i++) {
                    grid.innerHTML += '<div class="vine-grid-placeholder"></div>';
                }
            }
            
            // Generate thumbnails after grid is loaded
            setTimeout(() => generateThumbnails(), 100);
        }

        // Load featured viners
        function loadFeaturedViners() {
            const vinersList = document.getElementById('featuredVinersList');
            if (!vinersList) return;
            
            const colors = ['#ff6b6b', '#4ecdc4', '#ffe66d', '#ff8cc8', '#95e1d3'];
            
            vinersList.innerHTML = FEATURED_USERS.map((user, index) => `
                <div class="vine-viner-item" onclick="window.location.href='featured-viners.html'">
                    <div class="vine-viner-avatar" style="background: ${colors[index % colors.length]}">
                        ${user.avatar}
                    </div>
                    <div class="vine-viner-info">
                        <div class="vine-viner-name">${user.username}</div>
                        <div class="vine-viner-followers">${user.followers} followers</div>
                    </div>
                </div>
            `).join('');
        }

        // Load trending videos
        function loadTrendingVideos() {
            const trendingGrid = document.getElementById('vineTrendingGrid');
            if (!trendingGrid) return;
            
            const trendingVideos = currentVideos.slice(3, 9);
            
            trendingGrid.innerHTML = trendingVideos.map((video, index) => `
                <div class="vine-grid-item" onclick="playVideo('${video.id}')">
                    <div class="vine-grid-thumbnail" id="trending-thumb-${video.id}">
                        <canvas width="400" height="400" style="width: 100%; height: 100%; position: absolute; top: 0; left: 0;"></canvas>
                        <div class="vine-grid-overlay">
                            <div class="vine-grid-avatar">${video.avatar}</div>
                            <span class="vine-grid-user">${video.username}</span>
                        </div>
                    </div>
                    <div class="vine-grid-info">
                        <div class="vine-grid-avatar" style="width: 20px; height: 20px; font-size: 10px;">${video.avatar}</div>
                        <span style="font-size: 11px; color: #333;">${video.username}</span>
                        <div class="vine-grid-stats">
                            <span>❤️ ${video.likes}</span>
                            <span>💬 ${video.comments}</span>
                            <span>🔄 ${video.reposts}</span>
                        </div>
                    </div>
                </div>
            `).join('');
            
            // Generate trending thumbnails
            setTimeout(() => {
                trendingVideos.forEach((video, index) => {
                    const canvas = document.querySelector(`#trending-thumb-${video.id} canvas`);
                    if (!canvas) return;
                    
                    const ctx = canvas.getContext('2d');
                    const colors = ['#ff6b6b', '#4ecdc4', '#ffe66d', '#ff8cc8', '#95e1d3'];
                    
                    // Generate thumbnails same as main grid
                    const tempVideo = document.createElement('video');
                    tempVideo.src = video.url;
                    tempVideo.muted = true;
                    tempVideo.crossOrigin = 'anonymous';
                    
                    tempVideo.addEventListener('loadeddata', () => {
                        tempVideo.currentTime = Math.min(1, tempVideo.duration * 0.1);
                    });
                    
                    tempVideo.addEventListener('seeked', () => {
                        try {
                            ctx.drawImage(tempVideo, 0, 0, 400, 400);
                        } catch (e) {
                            ctx.fillStyle = colors[index % colors.length];
                            ctx.fillRect(0, 0, 400, 400);
                            ctx.fillStyle = 'white';
                            ctx.font = '120px Arial';
                            ctx.textAlign = 'center';
                            ctx.textBaseline = 'middle';
                            ctx.fillText(video.avatar, 200, 200);
                        }
                        tempVideo.remove();
                    });
                    
                    tempVideo.addEventListener('error', () => {
                        ctx.fillStyle = colors[index % colors.length];
                        ctx.fillRect(0, 0, 400, 400);
                        ctx.fillStyle = 'white';
                        ctx.font = '120px Arial';
                        ctx.textAlign = 'center';
                        ctx.textBaseline = 'middle';
                        ctx.fillText(video.avatar, 200, 200);
                        tempVideo.remove();
                    });
                    
                    tempVideo.load();
                });
            }, 100);
        }

        // Setup video autoplay
        function setupVideoAutoplay() {
            setInterval(() => {
                featuredVideoIndex = (featuredVideoIndex + 1) % currentVideos.length;
                loadFeaturedVideo();
            }, 6000);
        }

        // Click to toggle play/pause
        document.addEventListener('DOMContentLoaded', () => {
            const player = document.getElementById('vineFeaturedPlayer');
            if (player) {
                player.addEventListener('click', (e) => {
                    e.preventDefault();
                    if (player.paused) {
                        player.play();
                    } else {
                        player.pause();
                    }
                });
            }
        });

        // Play video
        function playVideo(videoId) {
            const videoIndex = currentVideos.findIndex(v => v.id === videoId);
            if (videoIndex !== -1) {
                featuredVideoIndex = videoIndex;
                loadPlaylistVideo();
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        }

        // Setup hover preview for grid items
        function setupHoverPreviews() {
            const gridItems = document.querySelectorAll('.vine-grid-item');
            
            gridItems.forEach((item, index) => {
                const thumbnail = item.querySelector('.vine-grid-thumbnail');
                if (!thumbnail || !currentVideos[index]) return;
                
                let previewVideo = null;
                let hoverTimeout = null;
                
                item.addEventListener('mouseenter', () => {
                    // Delay preview to avoid accidental hovers
                    hoverTimeout = setTimeout(() => {
                        const video = currentVideos[index];
                        if (!video.url) return;
                        
                        // Create preview video element
                        previewVideo = document.createElement('video');
                        previewVideo.src = video.url;
                        previewVideo.muted = true;
                        previewVideo.loop = true;
                        previewVideo.style.position = 'absolute';
                        previewVideo.style.top = '0';
                        previewVideo.style.left = '0';
                        previewVideo.style.width = '100%';
                        previewVideo.style.height = '100%';
                        previewVideo.style.objectFit = 'cover';
                        previewVideo.style.zIndex = '5';
                        
                        thumbnail.appendChild(previewVideo);
                        previewVideo.play().catch(e => console.log('Preview play failed:', e));
                    }, 300); // 300ms delay before preview starts
                });
                
                item.addEventListener('mouseleave', () => {
                    // Clear timeout if mouse leaves before preview starts
                    if (hoverTimeout) {
                        clearTimeout(hoverTimeout);
                        hoverTimeout = null;
                    }
                    
                    // Remove preview video
                    if (previewVideo) {
                        previewVideo.pause();
                        previewVideo.remove();
                        previewVideo = null;
                    }
                });
            });
        }

        // Search functionality
        function searchVines() {
            const query = document.getElementById('vineSearchInput').value.trim();
            if (!query) return;
            
            console.log('Searching for:', query);
            const filtered = HOMEPAGE_VIDEOS.filter(v => 
                v.username.toLowerCase().includes(query.toLowerCase()) ||
                v.category.toLowerCase().includes(query.toLowerCase())
            );
            
            if (filtered.length > 0) {
                currentVideos = filtered;
                loadVideoGrid();
                loadFeaturedVideo();
                setTimeout(setupHoverPreviews, 100);
            } else {
                alert('No vines found for: ' + query);
            }
        }

        // Filter by category
        function filterByCategory(category) {
            console.log('Filtering by:', category);
            const filtered = HOMEPAGE_VIDEOS.filter(v => v.category === category);
            
            if (filtered.length > 0) {
                currentVideos = filtered;
                featuredVideoIndex = 0; // Reset to first video
                loadVideoFeed(); // Update the feed display
                // Also update grid if it exists
                if (document.getElementById('vineVideoGrid')) {
                    loadVideoGrid();
                }
            } else {
                // Show all videos if no matches
                currentVideos = shuffleArray([...HOMEPAGE_VIDEOS]);
                featuredVideoIndex = 0;
                loadVideoFeed();
                console.log(`No ${category} vines found, showing all`);
            }
        }

        // View profile
        function viewProfile(username) {
            console.log('Viewing profile:', username);
            window.location.href = `/${encodeURIComponent(username)}`;
        }

        // Show playlist
        function showPlaylist(playlistType) {
            console.log('Showing playlist:', playlistType);
            
            if (playlistType === 'editors-picks') {
                // Show curated editor's picks
                currentVideos = HOMEPAGE_VIDEOS.filter((v, i) => i % 2 === 0); // Even indexed videos
                loadVideoGrid();
                loadFeaturedVideo();
                alert("Editor's Picks - Curated selection of the best vines!");
            } else if (playlistType === 'featured') {
                // Show featured viners' videos
                currentVideos = HOMEPAGE_VIDEOS.filter((v, i) => i % 2 === 1); // Odd indexed videos
                loadVideoGrid();
                loadFeaturedVideo();
                alert("Featured Viners - Trending creators and their best content!");
            }
            
            setTimeout(setupHoverPreviews, 100);
        }

        // Handle enter key in search
        document.addEventListener('DOMContentLoaded', () => {
            const searchInput = document.getElementById('vineSearchInput');
            if (searchInput) {
                searchInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        searchVines();
                    }
                });
            }
        });

        // Try to load from vine-integration.js if available
        function loadFromVineIntegration() {
            // This will integrate with the vine-integration.js file if it loads
            if (typeof window.VineState !== 'undefined' && window.VineState.videos && window.VineState.videos.length > 0) {
                // Only replace if we actually have videos
                console.log('Vine integration found with', window.VineState.videos.length, 'videos');
                currentVideos = window.VineState.videos;
                loadPlaylistVideo();
                // Don't reload featured content - keep our custom comedy videos
                // loadFeaturedCategoryVideos();
                // loadVideoGrid();
                // setTimeout(setupHoverPreviews, 100);
            } else {
                console.log('No vine integration data found, keeping preloaded content');
            }
        }

        // Load featured category videos
        function loadFeaturedCategoryVideos(category = 'comedy') {
            const grid = document.getElementById('featuredCategoryGrid');
            const titleElement = document.querySelector('.vine-featured-section .vine-section-title');
            if (!grid) return;
            
            // Update the section title
            const categoryNames = {
                'comedy': 'Comedy',
                'gaming': 'Gaming', 
                'cool': 'Cool',
                'trending': 'Trending',
                'special': 'Special',
                'animals': 'Animals',
                'sports': 'Sports',
                'musicdance': 'Music & Dance',
                'ideas': 'Ideas',
                'editors-picks': 'Editor\'s Picks'
            };
            
            if (titleElement) {
                titleElement.innerHTML = `
                    <div class="vine-category-icon">📹</div>
                    Featured in ${categoryNames[category] || category}
                `;
            }
            
            // Get videos from the specified category
            const categoryVideos = HOMEPAGE_VIDEOS.filter(v => v.category === category).slice(0, 3).map(video => ({
                id: video.id,
                url: video.url,
                username: video.username,
                avatar: video.avatar,
                caption: video.title,
                loops: video.loops
            }));
            
            grid.innerHTML = categoryVideos.map(video => `
                <div class="vine-featured-item" onclick="playFromPlaylist('${video.id}')">
                    <div class="vine-featured-thumb">
                        <video src="${video.url}" muted preload="metadata" onloadedmetadata="this.currentTime = 1" 
                               onclick="event.stopPropagation(); this.muted = false; this.volume = 1.0;"></video>
                    </div>
                    <div class="vine-featured-info">
                        <div class="vine-featured-user">
                            <span class="vine-user-avatar-small">${video.avatar}</span>
                            <span class="vine-username-small">${video.username}</span>
                        </div>
                        <p class="vine-featured-caption">${video.caption}</p>
                        <p class="vine-loop-count-small">${video.loops === 0 ? 'unknown' : video.loops.toLocaleString()} Loops</p>
                    </div>
                </div>
            `).join('');
        }
        
        // Load featured viners row
        function loadFeaturedVinersRow() {
            const row = document.getElementById('featuredVinersRow');
            if (!row) return;
            
            // Get unique users from our video data
            const uniqueUsers = [...new Set(currentVideos.map(v => v.username))].slice(0, 4);
            const colors = ['#ff6b6b', '#4ecdc4', '#ffe66d', '#333'];
            const viners = uniqueUsers.map((username, index) => {
                const userVideo = currentVideos.find(v => v.username === username);
                return {
                    name: username,
                    avatar: userVideo ? userVideo.avatar : '👤',
                    color: colors[index]
                };
            });
            
            row.innerHTML = viners.map(viner => `
                <div class="vine-viner-circle" onclick="viewProfile('${viner.name}')">
                    <div class="vine-viner-avatar" style="background: ${viner.color}">
                        ${viner.avatar}
                    </div>
                    <p class="vine-viner-name">${viner.name}</p>
                </div>
            `).join('');
        }
        
        // Load editor's pick video
        function loadEditorsPickVideo() {
            const container = document.getElementById('editorsPickVideo');
            if (!container) return;
            
            // Pick a random video as editor's pick
            const editorsPick = currentVideos[Math.floor(Math.random() * currentVideos.length)];
            
            container.innerHTML = `
                <video src="${editorsPick.url}" 
                       id="editors-pick-video"
                       ${isMuted ? 'muted' : ''}
                       loop
                       playsinline
                       onclick="toggleEditorsPickVideo()"
                       onmouseover="this.play()" 
                       onmouseout="this.pause()">
                </video>
            `;
        }
        
        // Toggle editor's pick video
        function toggleEditorsPickVideo() {
            const video = document.getElementById('editors-pick-video');
            if (!video) return;
            
            if (video.paused) {
                // If unmuting for the first time, unmute all videos globally
                if (isMuted) {
                    isMuted = false;
                    // Unmute all videos
                    document.querySelectorAll('video').forEach(v => {
                        v.muted = false;
                    });
                }
                video.play();
            } else {
                video.pause();
            }
        }
        
        // Setup playlist navigation
        function setupPlaylistNavigation() {
            const player = document.getElementById('vinePlaylistPlayer');
            if (!player) return;
            
            // Click to toggle mute/unmute
            player.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                
                if (player.muted || player.volume === 0) {
                    // Unmute
                    player.muted = false;
                    player.volume = 1.0;
                    isMuted = false;
                    // Sync with VineState if available
                    if (typeof window.VineState !== 'undefined') {
                        window.VineState.playlistMuted = false;
                    }
                    
                    // Show unmute indicator
                    const indicator = document.createElement('div');
                    indicator.style.cssText = `
                        position: fixed;
                        top: 50%;
                        left: 50%;
                        transform: translate(-50%, -50%);
                        background: rgba(0, 0, 0, 0.8);
                        color: white;
                        padding: 10px 20px;
                        border-radius: 20px;
                        font-size: 14px;
                        z-index: 1000;
                        pointer-events: none;
                    `;
                    indicator.textContent = '🔊 Sound On';
                    document.body.appendChild(indicator);
                    
                    setTimeout(() => {
                        indicator.remove();
                    }, 1000);
                    
                    console.log('Audio unmuted - volume:', player.volume, 'muted:', player.muted);
                } else {
                    // Mute
                    player.muted = true;
                    isMuted = true;
                    // Sync with VineState if available
                    if (typeof window.VineState !== 'undefined') {
                        window.VineState.playlistMuted = true;
                    }
                    console.log('Audio muted');
                }
            });
            
            // Also add handler to the wrapper
            const wrapper = player.closest('.vine-video-wrapper');
            if (wrapper) {
                wrapper.addEventListener('click', (e) => {
                    if (e.target !== player) {
                        player.click();
                    }
                });
            }
        }
        
        // Advance playlist
        function advancePlaylist() {
            featuredVideoIndex = (featuredVideoIndex + 1) % currentVideos.length;
            loadPlaylistVideo();
        }
        
        // Play from playlist
        function playFromPlaylist(videoId) {
            console.log('Playing video:', videoId);
            console.log('Current videos length:', currentVideos.length);
            const index = currentVideos.findIndex(v => v.id === videoId);
            console.log('Found index:', index);
            if (index !== -1) {
                featuredVideoIndex = index;
                loadPlaylistVideo();
                // Scroll to playlist
                document.querySelector('.vine-playlist-container').scrollIntoView({ behavior: 'smooth' });
            } else {
                // Video not in current list, find it in all videos and play directly
                const video = HOMEPAGE_VIDEOS.find(v => v.id === videoId);
                if (video) {
                    console.log('Video found in all videos, playing directly');
                    const player = document.getElementById('vinePlaylistPlayer');
                    if (player) {
                        player.src = video.url;
                        player.load();
                        player.play();
                    }
                }
            }
        }
        
        // Helper functions
        
        function shareVideo() {
            alert('Share functionality coming soon!');
        }
        
        function likeVideo() {
            alert('Like functionality coming soon!');
        }
        
        // Navigation functions
        function previousVideo() {
            if (currentVideos.length === 0) return;
            featuredVideoIndex = (featuredVideoIndex - 1 + currentVideos.length) % currentVideos.length;
            loadPlaylistVideo();
        }
        
        function nextVideo() {
            if (currentVideos.length === 0) return;
            featuredVideoIndex = (featuredVideoIndex + 1) % currentVideos.length;
            loadPlaylistVideo();
        }
        
        // Category filtering function  
        function filterByCategory(category) {
            console.log('Filtering by:', category);
            const filtered = HOMEPAGE_VIDEOS.filter(v => v.category === category);
            
            if (filtered.length > 0) {
                currentVideos = filtered;
                loadVideoFeed(); // Reload the feed with filtered videos
                
                console.log(`Filtered to ${filtered.length} videos in category: ${category}`);
            } else {
                // Reset to all videos if no matches
                currentVideos = [...HOMEPAGE_VIDEOS];
                loadVideoFeed();
                console.log(`No videos found for category: ${category}, showing all videos`);
            }
        }

        // Generate video thumbnails dynamically
        function generateThumbnails() {
            currentVideos.forEach((video, index) => {
                const thumbnailContainer = document.getElementById(`thumb-${video.id}`);
                if (!thumbnailContainer) return;
                
                const canvas = thumbnailContainer.querySelector('canvas');
                if (!canvas) return;
                
                const ctx = canvas.getContext('2d');
                const colors = ['#ff6b6b', '#4ecdc4', '#ffe66d', '#ff8cc8', '#95e1d3'];
                
                // Create a temporary video element to extract frame
                const tempVideo = document.createElement('video');
                tempVideo.src = video.url;
                tempVideo.muted = true;
                tempVideo.crossOrigin = 'anonymous';
                
                tempVideo.addEventListener('loadeddata', () => {
                    // Seek to 1 second or 10% of video duration
                    tempVideo.currentTime = Math.min(1, tempVideo.duration * 0.1);
                });
                
                tempVideo.addEventListener('seeked', () => {
                    try {
                        // Draw the video frame to canvas
                        ctx.drawImage(tempVideo, 0, 0, 400, 400);
                    } catch (e) {
                        // If video can't be drawn (CORS, etc), create colorful placeholder
                        ctx.fillStyle = colors[index % colors.length];
                        ctx.fillRect(0, 0, 400, 400);
                        ctx.fillStyle = 'white';
                        ctx.font = '120px Arial';
                        ctx.textAlign = 'center';
                        ctx.textBaseline = 'middle';
                        ctx.fillText(video.avatar, 200, 200);
                    }
                    
                    // Clean up
                    tempVideo.remove();
                });
                
                tempVideo.addEventListener('error', () => {
                    // Create colorful placeholder on error
                    ctx.fillStyle = colors[index % colors.length];
                    ctx.fillRect(0, 0, 400, 400);
                    ctx.fillStyle = 'white';
                    ctx.font = '120px Arial';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText(video.avatar, 200, 200);
                    
                    tempVideo.remove();
                });
                
                // Start loading
                tempVideo.load();
            });
        }
    </script>
    <script src="vine-integration.js?v=1"></script>

    <footer>
        <div class="footer-content">
            <p>Made with 💚 by <a href="https://rabblelabs.com" target="_blank">Rabble Labs</a> | 
            Built on <a href="https://nostr.com" target="_blank">Nostr Protocol</a> | 
            <a href="about.html">About OpenVine</a> | 
            <a href="https://github.com/rabble/nostrvine" target="_blank">Source Code</a></p>
            <p class="footer-mission">🌱 Liberating Vine, one loop at a time | Building a social media ecosystem where users have <a href="https://rights.social" target="_blank">rights</a></p>
        </div>
    </footer>
</body>
</html>