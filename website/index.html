<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpenVine - Explore Looping Videos</title>
    <link rel="stylesheet" href="styles.css?v=4">
    <link rel="stylesheet" href="single-player-styles.css?v=4">
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <meta name="description" content="OpenVine - Explore a world of beautiful, looping videos powered by Nostr">
    <style>
        /* Additional styles for the new design */
        body {
            background-color: #fff;
        }
        
        .hero {
            background: linear-gradient(135deg, #0ae68a 0%, #08b56a 100%);
            padding: 3rem 2rem;
            position: relative;
            overflow: hidden;
        }
        
        .hero::before {
            content: '';
            position: absolute;
            width: 200%;
            height: 200%;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><rect x="0" y="0" width="50" height="50" fill="rgba(255,255,255,0.03)"/><rect x="50" y="50" width="50" height="50" fill="rgba(255,255,255,0.03)"/></svg>');
            animation: slide 20s linear infinite;
            top: -50%;
            left: -50%;
        }
        
        @keyframes slide {
            0% { transform: translate(0, 0); }
            100% { transform: translate(50px, 50px); }
        }
        
        .hero h2 {
            color: white;
            font-size: 2rem;
            font-weight: 400;
            margin-bottom: 1rem;
            position: relative;
        }
        
        .hero p {
            color: rgba(255,255,255,0.9);
            font-size: 1.2rem;
            margin-bottom: 2rem;
            position: relative;
        }
        
        .search-container {
            position: relative;
            z-index: 10;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }
        
        .search-button {
            background-color: #333;
        }
        
        .quick-actions {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-top: 1.5rem;
            position: relative;
        }
        
        .quick-action {
            background: rgba(255,255,255,0.2);
            backdrop-filter: blur(10px);
            padding: 0.75rem 1.5rem;
            border-radius: 25px;
            color: white;
            text-decoration: none;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            border: 1px solid rgba(255,255,255,0.3);
        }
        
        .quick-action:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-2px);
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 250px 1fr 300px;
            gap: 2rem;
            padding: 2rem;
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .channels {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
        }
        
        .channels h3 {
            font-size: 1rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #666;
            margin-bottom: 1.5rem;
        }
        
        .channel-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }
        
        .channel-item {
            background: #f5f5f5;
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 12px;
            font-size: 2rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .channel-item:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        /* Color palette for channels */
        .channel-item:nth-child(1) { background: #f39c12; }
        .channel-item:nth-child(2) { background: #e74c3c; }
        .channel-item:nth-child(3) { background: #9b59b6; }
        .channel-item:nth-child(4) { background: #e91e63; }
        .channel-item:nth-child(5) { background: #3498db; }
        .channel-item:nth-child(6) { background: #00bcd4; }
        .channel-item:nth-child(7) { background: #1abc9c; }
        .channel-item:nth-child(8) { background: #2ecc71; }
        .channel-item:nth-child(9) { background: #f1c40f; }
        .channel-item:nth-child(10) { background: #ff9800; }
        .channel-item:nth-child(11) { background: #795548; }
        .channel-item:nth-child(12) { background: #607d8b; }
        
        .vine-playlist {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
        }
        
        .playlist-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1.5rem;
        }
        
        .playlist-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: #333;
        }
        
        .video-player-container {
            background: #000;
            border-radius: 12px;
            overflow: hidden;
            position: relative;
            margin-bottom: 1.5rem;
        }
        
        .video-meta {
            padding: 1rem;
            border-bottom: 1px solid #eee;
        }
        
        .video-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #333;
            margin-bottom: 0.5rem;
        }
        
        .video-stats {
            display: flex;
            gap: 1.5rem;
            color: #666;
            font-size: 0.9rem;
        }
        
        .video-list {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .video-list-item {
            display: flex;
            gap: 1rem;
            padding: 0.75rem;
            cursor: pointer;
            transition: background 0.2s ease;
            border-radius: 8px;
        }
        
        .video-list-item:hover {
            background: #f5f5f5;
        }
        
        .video-list-item.active {
            background: #e8f5e9;
        }
        
        .video-thumb {
            width: 80px;
            height: 80px;
            background: #333;
            border-radius: 8px;
            overflow: hidden;
            flex-shrink: 0;
        }
        
        .video-thumb img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .video-list-info h4 {
            font-size: 0.9rem;
            font-weight: 600;
            color: #333;
            margin-bottom: 0.25rem;
        }
        
        .video-list-info p {
            font-size: 0.8rem;
            color: #666;
        }
        
        .featured-viners {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
        }
        
        .featured-viners h3 {
            font-size: 1rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #666;
            margin-bottom: 1.5rem;
        }
        
        .viner-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        
        .viner-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.75rem;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.2s ease;
        }
        
        .viner-item:hover {
            background: #f5f5f5;
        }
        
        .viner-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: #333;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            flex-shrink: 0;
        }
        
        .viner-info h4 {
            font-size: 1rem;
            font-weight: 600;
            color: #333;
            margin-bottom: 0.25rem;
        }
        
        .viner-info p {
            font-size: 0.8rem;
            color: #666;
        }
        
        .editor-pick {
            background: #fef3c7;
            border-radius: 12px;
            padding: 1.5rem;
            margin-top: 1.5rem;
        }
        
        .editor-pick h3 {
            font-size: 1rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #92400e;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .editor-pick-content {
            display: flex;
            gap: 1rem;
            align-items: center;
        }
        
        .editor-pick-thumb {
            width: 100px;
            height: 100px;
            background: #333;
            border-radius: 8px;
            overflow: hidden;
            flex-shrink: 0;
        }
        
        .editor-pick-info h4 {
            font-size: 1rem;
            font-weight: 600;
            color: #333;
            margin-bottom: 0.5rem;
        }
        
        .editor-pick-info p {
            font-size: 0.9rem;
            color: #666;
            line-height: 1.4;
        }
        
        @media (max-width: 1200px) {
            .main-content {
                grid-template-columns: 200px 1fr 250px;
                gap: 1.5rem;
                padding: 1.5rem;
            }
        }
        
        @media (max-width: 900px) {
            .main-content {
                grid-template-columns: 1fr;
                gap: 1.5rem;
            }
            
            .channels {
                order: 2;
            }
            
            .vine-playlist {
                order: 1;
            }
            
            .right-sidebar {
                order: 3;
            }
            
            .channel-grid {
                grid-template-columns: repeat(6, 1fr);
            }
        }
        
        @media (max-width: 600px) {
            .quick-actions {
                flex-wrap: wrap;
            }
            
            .hero h2 {
                font-size: 1.5rem;
            }
            
            .channel-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }
    </style>
</head>
<body>
    <header>
        <nav>
            <div class="nav-container">
                <div class="logo">
                    <h1>🍇 Vine</h1>
                </div>
                <div class="nav-links">
                    <a href="#" class="nav-button active">Home</a>
                    <a href="trending.html" class="nav-button">Trending</a>
                    <a href="about.html" class="nav-button">About</a>
                    <a href="https://app.openvine.co" class="nav-button" target="_blank">Open App</a>
                </div>
            </div>
        </nav>
    </header>

    <section class="hero">
        <h2>Explore a world of beautiful, looping videos.</h2>
        <div class="search-container">
            <input type="text" class="search-input" placeholder="Search for vines..." id="searchInput">
            <button class="search-button" onclick="searchVines()">🔍</button>
        </div>
        <div class="quick-actions">
            <a href="#" class="quick-action" onclick="loadIosApp()">Get it for iOS</a>
            <a href="#" class="quick-action" onclick="loadAndroidApp()">Get it for Android</a>
            <a href="#" class="quick-action" onclick="loadWindowsApp()">Get it for Windows</a>
        </div>
    </section>

    <main>
        <div class="main-content">
            <!-- Left Sidebar - Channels -->
            <aside class="channels">
                <h3>Channels</h3>
                <div class="channel-grid">
                    <div class="channel-item" onclick="filterByCategory('music')">🎵</div>
                    <div class="channel-item" onclick="filterByCategory('comedy')">😂</div>
                    <div class="channel-item" onclick="filterByCategory('animals')">🐱</div>
                    <div class="channel-item" onclick="filterByCategory('gaming')">🎮</div>
                    <div class="channel-item" onclick="filterByCategory('art')">🎨</div>
                    <div class="channel-item" onclick="filterByCategory('sports')">⚽</div>
                    <div class="channel-item" onclick="filterByCategory('nature')">🌿</div>
                    <div class="channel-item" onclick="filterByCategory('food')">🍔</div>
                    <div class="channel-item" onclick="filterByCategory('tech')">💻</div>
                    <div class="channel-item" onclick="filterByCategory('dance')">💃</div>
                    <div class="channel-item" onclick="filterByCategory('travel')">✈️</div>
                    <div class="channel-item" onclick="filterByCategory('diy')">🔨</div>
                </div>
            </aside>

            <!-- Center - Video Player and Playlist -->
            <section class="vine-playlist">
                <div class="playlist-header">
                    <h3 class="playlist-title">📋 Vine Playlist</h3>
                    <span id="video-count" style="color: #666; font-size: 0.9rem;">Loading...</span>
                </div>

                <!-- Video Player -->
                <div class="video-player-container">
                    <div class="video-wrapper">
                        <video 
                            id="main-vine-player" 
                            class="vine-video" 
                            autoplay 
                            muted
                            playsinline
                            poster="data:image/svg+xml,%3Csvg width='400' height='400' xmlns='http://www.w3.org/2000/svg'%3E%3Crect width='400' height='400' fill='%23333'/%3E%3C/svg%3E">
                        </video>
                        
                        <div class="unmute-overlay" id="unmute-overlay">
                            <div class="unmute-content">
                                <span class="unmute-icon">🔇</span>
                                <p class="unmute-text">Tap to unmute</p>
                            </div>
                        </div>
                        
                        <button class="nav-btn prev-btn" onclick="previousVideo()">‹</button>
                        <button class="nav-btn next-btn" onclick="nextVideo()">›</button>
                    </div>
                </div>

                <!-- Video Info -->
                <div class="video-meta" id="video-meta">
                    <h4 class="video-title" id="current-video-title">Loading...</h4>
                    <div class="video-stats">
                        <span>❤️ <span id="video-likes">0</span> Likes</span>
                        <span>👁️ <span id="video-views">0</span> Views</span>
                        <span>🔄 <span id="loop-count">0</span> Loops</span>
                    </div>
                </div>

                <!-- Video List -->
                <div class="video-list" id="video-list">
                    <!-- Videos will be loaded here -->
                </div>
            </section>

            <!-- Right Sidebar -->
            <aside class="right-sidebar">
                <!-- Featured Viners -->
                <div class="featured-viners">
                    <h3>⭐ Featured Viners</h3>
                    <div class="viner-list" id="featured-viners-list">
                        <!-- Viners will be loaded here -->
                    </div>
                </div>

                <!-- Editor's Pick -->
                <div class="editor-pick">
                    <h3>📌 Editor's Pick</h3>
                    <div class="editor-pick-content">
                        <div class="editor-pick-thumb">
                            <img src="" alt="Editor's pick" id="editor-pick-thumb">
                        </div>
                        <div class="editor-pick-info">
                            <h4 id="editor-pick-title">Amazing Vine</h4>
                            <p id="editor-pick-desc">Check out this incredible loop!</p>
                        </div>
                    </div>
                </div>
            </aside>
        </div>
    </main>

    <footer>
        <p>Powered by Nostr Protocol | OpenVine 2024 | <a href="https://github.com/rabble/nostrvine" target="_blank">Source Code: GitHub</a></p>
        <p>We believe in the rights laid out in <a href="https://rights.social" target="_blank">rights.social</a></p>
    </footer>

    <script>
        // Constants
        const ANALYTICS_API = 'https://analytics.openvine.co/analytics';
        const VIEW_TRACKING_API = 'https://analytics.openvine.co/analytics/view';
        const NOSTR_RELAYS = [
            'wss://relay.damus.io',
            'wss://nos.lol',
            'wss://relay.nos.social',
            'wss://relay.nostr.band',
            'wss://cache2.primal.net/v1'
        ];

        // State
        let videos = [];
        let currentVideoIndex = 0;
        let loopCount = 0;
        const MAX_LOOPS = 4;
        let globalMuteState = true;
        let nostrEventMap = new Map();

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadTrendingContent();
            setupVideoPlayer();
        });

        // Load trending content from analytics API
        async function loadTrendingContent() {
            try {
                // Load trending videos
                const vinesResponse = await fetch(`${ANALYTICS_API}/trending/vines?limit=20`);
                const vinesData = await vinesResponse.json();

                if (vinesData.vines && vinesData.vines.length > 0) {
                    // Fetch actual video data from Nostr
                    const eventIds = vinesData.vines.map(v => v.eventId);
                    await fetchNostrEvents(eventIds);

                    // Process videos
                    videos = vinesData.vines.map(vine => {
                        const nostrEvent = nostrEventMap.get(vine.eventId);
                        return {
                            id: vine.eventId,
                            url: nostrEvent?.videoUrl,
                            title: nostrEvent?.title || `Vine ${vine.eventId.substring(0, 8)}`,
                            thumbnail: nostrEvent?.thumbnailUrl,
                            creator: nostrEvent?.pubkey || vine.creatorPubkey,
                            views: vine.views || 0,
                            likes: Math.floor((vine.views || 0) * 0.1), // Estimate likes
                            loops: Math.floor((vine.views || 0) * 1.5) // Estimate loops
                        };
                    }).filter(v => v.url); // Only keep videos with URLs

                    // Update UI
                    updateVideoList();
                    if (videos.length > 0) {
                        playVideo(0);
                    }

                    document.getElementById('video-count').textContent = `${videos.length} videos`;
                }

                // Load trending viners
                const vinersResponse = await fetch(`${ANALYTICS_API}/trending/viners?limit=5`);
                const vinersData = await vinersResponse.json();

                if (vinersData.viners && vinersData.viners.length > 0) {
                    updateFeaturedViners(vinersData.viners);
                }

            } catch (error) {
                console.error('Error loading trending content:', error);
                document.getElementById('video-count').textContent = 'Error loading videos';
            }
        }

        // Fetch Nostr events
        async function fetchNostrEvents(eventIds) {
            const promises = NOSTR_RELAYS.map(relay => fetchEventsFromRelay(relay, eventIds));
            await Promise.allSettled(promises);
        }

        // Fetch from single relay
        function fetchEventsFromRelay(relayUrl, eventIds) {
            return new Promise((resolve) => {
                try {
                    const ws = new WebSocket(relayUrl);
                    const subscriptionId = 'sub_' + Math.random().toString(36).substring(2);
                    
                    ws.onopen = () => {
                        const filter = { kinds: [22], ids: eventIds };
                        ws.send(JSON.stringify(['REQ', subscriptionId, filter]));
                    };
                    
                    ws.onmessage = (event) => {
                        try {
                            const message = JSON.parse(event.data);
                            if (message[0] === 'EVENT' && message[2]?.kind === 22) {
                                const parsed = parseVideoEvent(message[2]);
                                if (parsed?.videoUrl) {
                                    nostrEventMap.set(message[2].id, parsed);
                                }
                            } else if (message[0] === 'EOSE') {
                                ws.send(JSON.stringify(['CLOSE', subscriptionId]));
                                setTimeout(() => ws.close(), 100);
                            }
                        } catch (err) {
                            console.error('Parse error:', err);
                        }
                    };
                    
                    ws.onerror = () => resolve();
                    ws.onclose = () => resolve();
                    
                    setTimeout(() => {
                        if (ws.readyState === WebSocket.OPEN) ws.close();
                        resolve();
                    }, 5000);
                } catch (error) {
                    resolve();
                }
            });
        }

        // Parse video event
        function parseVideoEvent(event) {
            const data = {
                id: event.id,
                pubkey: event.pubkey,
                content: event.content,
                videoUrl: null,
                title: null,
                thumbnailUrl: null
            };
            
            for (const tag of event.tags || []) {
                if (!tag || tag.length < 2) continue;
                
                switch (tag[0]) {
                    case 'url':
                        data.videoUrl = tag[1].replace('apt.openvine.co', 'api.openvine.co');
                        break;
                    case 'title':
                        data.title = tag[1];
                        break;
                    case 'thumb':
                        data.thumbnailUrl = tag[1];
                        break;
                    case 'imeta':
                        parseImetaTag(tag, data);
                        break;
                }
            }
            
            return data;
        }

        // Parse imeta tag
        function parseImetaTag(tag, data) {
            for (let i = 1; i < tag.length; i++) {
                const part = tag[i];
                if (part.includes(' ')) {
                    const [key, ...valueParts] = part.split(' ');
                    const value = valueParts.join(' ');
                    
                    if (key === 'url' && !data.videoUrl) {
                        data.videoUrl = value.replace('apt.openvine.co', 'api.openvine.co');
                    } else if (key === 'blurhash') {
                        data.blurhash = value;
                    }
                }
            }
        }

        // Setup video player
        function setupVideoPlayer() {
            const video = document.getElementById('main-vine-player');
            if (!video) return;

            video.removeAttribute('controls');
            video.muted = globalMuteState;
            video.loop = false;

            video.addEventListener('ended', () => {
                loopCount++;
                document.getElementById('loop-count').textContent = loopCount;
                
                if (loopCount >= MAX_LOOPS) {
                    loopCount = 0;
                    nextVideo();
                } else {
                    video.play();
                }
            });

            video.addEventListener('click', () => {
                if (video.paused) {
                    video.play();
                } else {
                    video.pause();
                }
            });

            // Unmute overlay
            const unmuteOverlay = document.getElementById('unmute-overlay');
            unmuteOverlay.addEventListener('click', () => {
                globalMuteState = false;
                video.muted = false;
                unmuteOverlay.classList.add('hidden');
                video.play();
            });
        }

        // Play video
        function playVideo(index) {
            if (index < 0 || index >= videos.length) return;

            currentVideoIndex = index;
            loopCount = 0;

            const video = document.getElementById('main-vine-player');
            const videoData = videos[index];

            // Update video
            video.src = videoData.url;
            video.load();
            video.muted = globalMuteState;

            // Update UI
            document.getElementById('current-video-title').textContent = videoData.title;
            document.getElementById('video-likes').textContent = videoData.likes.toLocaleString();
            document.getElementById('video-views').textContent = videoData.views.toLocaleString();
            document.getElementById('loop-count').textContent = '0';

            // Update active state in list
            document.querySelectorAll('.video-list-item').forEach((item, i) => {
                item.classList.toggle('active', i === index);
            });

            // Track view
            trackVideoView(videoData);

            video.play().catch(console.log);
        }

        // Navigation
        function nextVideo() {
            playVideo((currentVideoIndex + 1) % videos.length);
        }

        function previousVideo() {
            playVideo((currentVideoIndex - 1 + videos.length) % videos.length);
        }

        // Update video list UI
        function updateVideoList() {
            const listContainer = document.getElementById('video-list');
            listContainer.innerHTML = videos.map((video, index) => `
                <div class="video-list-item ${index === 0 ? 'active' : ''}" onclick="playVideo(${index})">
                    <div class="video-thumb">
                        ${video.thumbnail ? 
                            `<img src="${video.thumbnail}" alt="${video.title}">` : 
                            `<div style="background: #333; width: 100%; height: 100%;"></div>`
                        }
                    </div>
                    <div class="video-list-info">
                        <h4>${video.title}</h4>
                        <p>${video.views.toLocaleString()} views</p>
                    </div>
                </div>
            `).join('');
        }

        // Update featured viners
        function updateFeaturedViners(viners) {
            const container = document.getElementById('featured-viners-list');
            const colors = ['#ff6b6b', '#4ecdc4', '#ffe66d', '#95e1d3', '#ff8cc8'];
            
            container.innerHTML = viners.slice(0, 5).map((viner, index) => `
                <div class="viner-item">
                    <div class="viner-avatar" style="background: ${colors[index % colors.length]};">
                        ${['🎭', '🎨', '🎬', '🎪', '🌟'][index % 5]}
                    </div>
                    <div class="viner-info">
                        <h4>Creator #${index + 1}</h4>
                        <p>${viner.totalViews.toLocaleString()} total views</p>
                    </div>
                </div>
            `).join('');
        }

        // Track video view
        async function trackVideoView(video) {
            try {
                await fetch(VIEW_TRACKING_API, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        eventId: video.id,
                        source: 'website',
                        creatorPubkey: video.creator
                    })
                });
            } catch (error) {
                console.error('Error tracking view:', error);
            }
        }

        // Search functionality
        async function searchVines() {
            const query = document.getElementById('searchInput').value.trim();
            if (!query) return;
            
            console.log('Searching for:', query);
            
            // Update UI to show searching state
            document.getElementById('video-count').textContent = 'Searching...';
            document.getElementById('video-list').innerHTML = '<div style="text-align: center; padding: 2rem; color: #666;">Searching Nostr relays...</div>';
            
            // Clear current videos
            videos = [];
            nostrEventMap.clear();
            
            // Search Nostr relays
            await searchNostrRelays(query);
            
            // Update UI with results
            if (videos.length > 0) {
                document.getElementById('video-count').textContent = `Found ${videos.length} videos`;
                updateVideoList();
                playVideo(0);
            } else {
                document.getElementById('video-count').textContent = 'No results found';
                document.getElementById('video-list').innerHTML = '<div style="text-align: center; padding: 2rem; color: #666;">No videos found matching your search.</div>';
            }
        }
        
        // Search Nostr relays for Kind 22 events
        async function searchNostrRelays(query) {
            const promises = NOSTR_RELAYS.map(relay => searchRelay(relay, query));
            await Promise.allSettled(promises);
            
            // Process found events into videos
            const eventIds = Array.from(nostrEventMap.keys());
            videos = eventIds.map(id => {
                const event = nostrEventMap.get(id);
                return {
                    id: id,
                    url: event.videoUrl,
                    title: event.title || event.content || `Video ${id.substring(0, 8)}`,
                    thumbnail: event.thumbnailUrl,
                    creator: event.pubkey,
                    views: 0,
                    likes: 0,
                    loops: 0,
                    tags: event.tags || []
                };
            }).filter(v => v.url);
        }
        
        // Search a single relay
        function searchRelay(relayUrl, query) {
            return new Promise((resolve) => {
                try {
                    const ws = new WebSocket(relayUrl);
                    const subscriptionId = 'search_' + Math.random().toString(36).substring(2);
                    let receivedEvents = 0;
                    
                    ws.onopen = () => {
                        console.log(`Searching ${relayUrl} for: ${query}`);
                        
                        // Create filters for search
                        const filters = [];
                        
                        // Check if query looks like a hashtag
                        if (query.startsWith('#')) {
                            // Search by hashtag
                            const tag = query.substring(1).toLowerCase();
                            filters.push({
                                kinds: [22],
                                "#t": [tag],
                                limit: 50
                            });
                        } else {
                            // Search in content and tags
                            // Note: Most relays don't support content search, but we'll try
                            filters.push({
                                kinds: [22],
                                limit: 100
                            });
                        }
                        
                        // Send subscription
                        const reqMessage = JSON.stringify(['REQ', subscriptionId, ...filters]);
                        ws.send(reqMessage);
                    };
                    
                    ws.onmessage = (event) => {
                        try {
                            const message = JSON.parse(event.data);
                            
                            if (message[0] === 'EVENT' && message[2]?.kind === 22) {
                                const nostrEvent = message[2];
                                
                                // Check if event matches search query
                                if (eventMatchesQuery(nostrEvent, query)) {
                                    const parsed = parseVideoEvent(nostrEvent);
                                    if (parsed?.videoUrl && !nostrEventMap.has(nostrEvent.id)) {
                                        nostrEventMap.set(nostrEvent.id, parsed);
                                        receivedEvents++;
                                        console.log(`Found matching video: ${parsed.title || nostrEvent.id.substring(0, 8)}`);
                                    }
                                }
                            } else if (message[0] === 'EOSE') {
                                console.log(`Search complete on ${relayUrl}: ${receivedEvents} events found`);
                                ws.send(JSON.stringify(['CLOSE', subscriptionId]));
                                setTimeout(() => ws.close(), 100);
                            }
                        } catch (err) {
                            console.error('Parse error:', err);
                        }
                    };
                    
                    ws.onerror = () => resolve();
                    ws.onclose = () => resolve();
                    
                    // Timeout after 10 seconds for search
                    setTimeout(() => {
                        if (ws.readyState === WebSocket.OPEN) ws.close();
                        resolve();
                    }, 10000);
                } catch (error) {
                    console.error(`Failed to search ${relayUrl}:`, error);
                    resolve();
                }
            });
        }
        
        // Check if event matches search query
        function eventMatchesQuery(event, query) {
            const searchTerm = query.toLowerCase();
            
            // If searching by hashtag
            if (query.startsWith('#')) {
                const tag = searchTerm.substring(1);
                // Check if event has this hashtag
                return event.tags?.some(t => 
                    t[0] === 't' && t[1]?.toLowerCase() === tag
                );
            }
            
            // Search in content
            if (event.content?.toLowerCase().includes(searchTerm)) {
                return true;
            }
            
            // Search in tags
            for (const tag of event.tags || []) {
                // Check title tag
                if (tag[0] === 'title' && tag[1]?.toLowerCase().includes(searchTerm)) {
                    return true;
                }
                // Check hashtags
                if (tag[0] === 't' && tag[1]?.toLowerCase().includes(searchTerm)) {
                    return true;
                }
            }
            
            return false;
        }
        
        // Handle enter key in search input
        document.getElementById('searchInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                searchVines();
            }
        });

        // Category filtering
        async function filterByCategory(category) {
            console.log('Filtering by category:', category);
            
            // Map categories to common hashtags
            const categoryTags = {
                'music': ['music', 'song', 'beats', 'musician'],
                'comedy': ['comedy', 'funny', 'humor', 'lol'],
                'animals': ['animals', 'pets', 'dogs', 'cats', 'wildlife'],
                'gaming': ['gaming', 'games', 'gamer', 'gameplay'],
                'art': ['art', 'artist', 'drawing', 'painting', 'creative'],
                'sports': ['sports', 'fitness', 'workout', 'athlete'],
                'nature': ['nature', 'outdoors', 'landscape', 'environment'],
                'food': ['food', 'cooking', 'recipe', 'foodie'],
                'tech': ['tech', 'technology', 'coding', 'developer'],
                'dance': ['dance', 'dancing', 'dancer', 'choreography'],
                'travel': ['travel', 'adventure', 'explore', 'wanderlust'],
                'diy': ['diy', 'howto', 'tutorial', 'crafts']
            };
            
            const tags = categoryTags[category] || [category];
            
            // Update UI
            document.getElementById('video-count').textContent = `Searching ${category}...`;
            document.getElementById('video-list').innerHTML = '<div style="text-align: center; padding: 2rem; color: #666;">Loading category videos...</div>';
            
            // Clear current videos
            videos = [];
            nostrEventMap.clear();
            
            // Search for videos with these tags
            await searchMultipleTags(tags);
            
            // Update UI with results
            if (videos.length > 0) {
                document.getElementById('video-count').textContent = `${videos.length} ${category} videos`;
                updateVideoList();
                playVideo(0);
            } else {
                document.getElementById('video-count').textContent = `No ${category} videos found`;
                document.getElementById('video-list').innerHTML = `<div style="text-align: center; padding: 2rem; color: #666;">No ${category} videos found. Try searching for specific hashtags!</div>`;
            }
        }
        
        // Search for multiple tags
        async function searchMultipleTags(tags) {
            const promises = [];
            
            // Search each relay for each tag
            for (const relay of NOSTR_RELAYS) {
                for (const tag of tags) {
                    promises.push(searchRelayForTag(relay, tag));
                }
            }
            
            await Promise.allSettled(promises);
            
            // Process found events into videos
            const eventIds = Array.from(nostrEventMap.keys());
            videos = eventIds.map(id => {
                const event = nostrEventMap.get(id);
                return {
                    id: id,
                    url: event.videoUrl,
                    title: event.title || event.content || `Video ${id.substring(0, 8)}`,
                    thumbnail: event.thumbnailUrl,
                    creator: event.pubkey,
                    views: Math.floor(Math.random() * 10000), // Random for now
                    likes: Math.floor(Math.random() * 1000),
                    loops: Math.floor(Math.random() * 5000),
                    tags: event.tags || []
                };
            }).filter(v => v.url);
            
            // Sort by "popularity" (random for now)
            videos.sort((a, b) => b.views - a.views);
        }
        
        // Search relay for specific tag
        function searchRelayForTag(relayUrl, tag) {
            return new Promise((resolve) => {
                try {
                    const ws = new WebSocket(relayUrl);
                    const subscriptionId = 'tag_' + Math.random().toString(36).substring(2);
                    
                    ws.onopen = () => {
                        const filter = {
                            kinds: [22],
                            "#t": [tag.toLowerCase()],
                            limit: 20
                        };
                        
                        ws.send(JSON.stringify(['REQ', subscriptionId, filter]));
                    };
                    
                    ws.onmessage = (event) => {
                        try {
                            const message = JSON.parse(event.data);
                            
                            if (message[0] === 'EVENT' && message[2]?.kind === 22) {
                                const parsed = parseVideoEvent(message[2]);
                                if (parsed?.videoUrl && !nostrEventMap.has(message[2].id)) {
                                    nostrEventMap.set(message[2].id, parsed);
                                }
                            } else if (message[0] === 'EOSE') {
                                ws.send(JSON.stringify(['CLOSE', subscriptionId]));
                                setTimeout(() => ws.close(), 100);
                            }
                        } catch (err) {
                            console.error('Parse error:', err);
                        }
                    };
                    
                    ws.onerror = () => resolve();
                    ws.onclose = () => resolve();
                    
                    setTimeout(() => {
                        if (ws.readyState === WebSocket.OPEN) ws.close();
                        resolve();
                    }, 5000);
                } catch (error) {
                    resolve();
                }
            });
        }

        // App download handlers
        function loadIosApp() {
            window.open('https://apps.apple.com/app/openvine', '_blank');
        }

        function loadAndroidApp() {
            window.open('https://play.google.com/store/apps/details?id=co.openvine', '_blank');
        }

        function loadWindowsApp() {
            window.open('https://openvine.co/download/windows', '_blank');
        }
    </script>
</body>
</html>